name: Build and Release APK

on:
  push:
    tags:
      - 'v*' # 只有打 Tag (例如 v1.0.0) 时才触发

jobs:
  build:
    name: Build Android Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # 赋予上传 Release 的权限

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 设置 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: 'npm'

      # 3. 设置 Java 环境
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      # 4. 安装项目依赖
      - name: Install Dependencies
        run: npm install

      # 5. 生成原生代码 (Prebuild)
      - name: Expo Prebuild
        run: npx expo prebuild

      # 6. 【关键】配置签名信息
      # 解码 Base64 回文件，并把你的密码写入配置
      - name: Configure Keystore
        run: |
          # 1. 解码 Keystore 文件
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore
          
          # 2. 将变量注入 android/gradle.properties
          # 这样 React Native 构建时会自动读取这些变量
          echo "" >> android/gradle.properties
          echo "MYAPP_UPLOAD_STORE_FILE=release.keystore" >> android/gradle.properties
          echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/gradle.properties
          echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_STORE_PASSWORD }}" >> android/gradle.properties
          echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/gradle.properties

      # 7. 开始打包 APK
      - name: Build APK
        run: cd android && ./gradlew assembleRelease

      # 8. 上传到 GitHub Releases
      - name: Release APK
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # 上传生成好的 APK
          files: android/app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}